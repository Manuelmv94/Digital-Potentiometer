/*
 * DigiPot.c
 *
 *  Created on: Mar 4, 2017
 *      Author: manuel
 */


/*! **********************************************************************************************
* 2016  ITESM Campus Guadalajara. Laboratorio de Microcontroladores 
*  
*
* @file:      SPI.c
* @author(s): Manuel Madrigal Valenzuela; Efraín Duarte López
*
* @brief (Theory of Operation)
*     Pretty straight forward. It configures the SPI hardware and implements the transmission
*     functions.
*
**************************************************************************************************/


/*************************************************************************************************/
/*********************                 Includes                **********************/
/*************************************************************************************************/
#include "DigiPot.h"

/*************************************************************************************************/
/*********************                 Defines                    **********************/
/*************************************************************************************************/
#define CS PTBD_PTBD7
#define CSdir	PTBDD_PTBDD7

/*************************************************************************************************/
/*********************                 Typedefs                **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************              Function Prototypes              **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Variables                    **********************/
/*************************************************************************************************/
static bool Resistance_set;
/*************************************************************************************************/
/*********************              Global Variables              **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Static Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************                  Global Constants                    **********************/
/*************************************************************************************************/

/*************************************************************************************************/
/*********************              Exported Functions               **********************/
/*************************************************************************************************/

void DigiPot_Init(void)
{
  SPI_Init();
  CS=1;
  CSdir=1;
}

bool DigiPot_setResistance(bool terminal, u32 resistance)
{
	u8 data;
	Resistance_set=FALSE;
	resistance-=resistance/10;
	if(terminal==RAW && resistance>DIGIPOT_RESOLUTION && resistance<=DIGIPOT_BASE_RESISTANCE){
		data=(u8)((DIGIPOT_BASE_RESISTANCE-resistance)/DIGIPOT_RESOLUTION);
		Resistance_set=TRUE;
	}
	else if(terminal==RBW && resistance<(DIGIPOT_BASE_RESISTANCE-DIGIPOT_RESOLUTION))
	{
		data=(u8)(resistance/DIGIPOT_RESOLUTION);
		Resistance_set=TRUE;
	}
	if(Resistance_set)
	{
		SPI_SendData(0b11111111);
		do{
			__RESET_WATCHDOG();
		}while(SPI_TxIsBusy());
		CS=0;
		SPI_SendData(0b00010011);
		do{
			__RESET_WATCHDOG();
		}while(SPI_TxIsBusy());
		
		SPI_SendData(data);
		do{
			__RESET_WATCHDOG();
		}while(SPI_TxIsBusy());
		
		SPI_SendData(0b11111111);
		do{
			__RESET_WATCHDOG();
		}while(SPI_TxIsBusy());
		
		
		CS=1;
		
	}
	
	return Resistance_set;
	
	
}



//-------------------------------------------------------------------------------------------------


/*************************************************************************************************/
/*********************               Private Functions               **********************/
/*************************************************************************************************/

